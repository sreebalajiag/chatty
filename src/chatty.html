<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>

<body>
    <div style="display: flex; gap: 10px; position:fixed;bottom: 10px;
  right: 10px;">
        <div id="world"></div>
        <virtual-joystick id="joyStick" data-x="0" data-y="0"></virtual-joystick>
    </div>
    <script>
        var Example = Example || {};
        let playerHeight = 40;
        let playerWidth = 40;

        Example.friction = function () {

            var Engine = Matter.Engine,
                Render = Matter.Render,
                Runner = Matter.Runner,
                MouseConstraint = Matter.MouseConstraint,
                Mouse = Matter.Mouse,
                Composite = Matter.Composite,
                Bodies = Matter.Bodies;
                Composites = Matter.Composites,
                Common = Matter.Common;

            // create engine
            var engine = Engine.create(),
                world = engine.world;

            // create renderer
            var render = Render.create({
                element: document.body,
                engine: engine,
                options: {
                    background: "#fff",
                    wireframes: false,
                    width: window.innerWidth,
                    height: window.innerHeight,
                    showVelocity: true
                }
            });

            Render.run(render);

            // create runner
            var runner = Runner.create();
            Runner.run(runner, engine);

            let topWall = Bodies.rectangle(400, 0, 800, 50, { isStatic: true });
            let player = Bodies.rectangle(0, 0, playerWidth, playerHeight, { isStatic: true })
            // add bodies
            let joyStick = document.getElementById("joyStick");
            let defaultX = joyStick.dataset.x;
            let defaultY = joyStick.dataset.y;
            var handleJoyStickDown = function (event) {
                defaultX = parseInt(joyStick.dataset.x);
                defaultY = parseInt(joyStick.dataset.y);
            }
            var output = function (event) {
                let position = player.position;
                console.log(position);
                let defferenceX = defaultX - parseInt(event.target.dataset.x);
                let defferenceY = defaultY - parseInt(event.target.dataset.y);

                let newPositionX =  (defaultX - parseInt(event.target.dataset.x));
                let newPositionY = (defaultY - parseInt(event.target.dataset.y));
                if(newPositionX<0){
                    newPositionX = 1;
                }else if(newPositionY>0){
                    newPositionX = -1;
                }
                if(newPositionY<0){
                    newPositionY = 1;
                }else if(newPositionY>0){
                    newPositionY= -1;
                }
                newPositionX = event.target.dataset.force*newPositionX;
                newPositionY = event.target.dataset.force*newPositionY;
                newPositionX = position.x +newPositionX;
                newPositionY = position.y +newPositionY;

                newPositionX = Math.min(newPositionX, window.innerWidth - 300);
                newPositionX = Math.max(0, newPositionX);
                newPositionY = Math.min(newPositionY, window.innerHeight - 300);
                newPositionY = Math.max(0, newPositionY);

                Matter.Body.set(player, "position", {
                    x: newPositionX,
                    y: newPositionY
                });

            }

            document.getElementById("joyStick").addEventListener('joystickdown', handleJoyStickDown);
            document.getElementById("joyStick").addEventListener('joystickmove', output);


            Composite.add(world, [
                // walls
                topWall,
                Bodies.rectangle(400, 600, 800, 50, { isStatic: true }),
                Bodies.rectangle(800, 300, 50, 600, { isStatic: true }),
                Bodies.rectangle(0, 300, 50, 600, { isStatic: true })
            ]);

            Composite.add(world, [
                player
            ]);

            Composite.add(world, [
                Bodies.rectangle(window.innerWidth / 2, 250, 40, 40, { friction: 0.0005 })
            ]);

            Composite.add(world, [
                Bodies.rectangle(window.innerWidth / 2, 430, 40, 40, { friction: 0 })
            ]);
            let stack = Composites.stack(20, 20, 20, 5, 0, 0, function (x, y) {
                return Bodies.circle(x, y, Common.random(10, 20), { friction: 0.00001, restitution: 0.5, density: 0.001 });
            });

            Composite.add(world, stack);

            // add mouse control
            var mouse = Mouse.create(render.canvas),
                mouseConstraint = MouseConstraint.create(engine, {
                    mouse: mouse,
                    constraint: {
                        stiffness: 0.2,
                        render: {
                            visible: false
                        }
                    }
                });

            Composite.add(world, mouseConstraint);

            // keep the mouse in sync with rendering
            render.mouse = mouse;

            // fit the render viewport to the scene
            Render.lookAt(render, {
                min: { x: 0, y: 0 },
                max: { x: 800, y: 600 }
            });

            // context for MatterTools.Demo
            return {
                engine: engine,
                runner: runner,
                render: render,
                canvas: render.canvas,
                stop: function () {
                    Matter.Render.stop(render);
                    Matter.Runner.stop(runner);
                }
            };
        };

        Example.friction.title = 'Friction';
        Example.friction.for = '>=0.14.2';

        if (typeof module !== 'undefined') {
            module.exports = Example.friction;
        }
        Example.friction();

    </script>
    <script src="virtual-joystick.js"></script>
</body>

</html>